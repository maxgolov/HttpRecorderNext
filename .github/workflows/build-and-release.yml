name: Build and Release

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20.x'
  CONFIGURATION: 'Release'

jobs:
  build:
    name: Build All Components (Ubuntu)
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: extensions/traffic-recorder/package-lock.json
      
      - name: Install Xvfb and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0 libxss1 libasound2 libsecret-1-0
      
      - name: Get Version
        id: get_version
        run: |
          # Get version from package.json
          VERSION=$(node -p "require('./extensions/traffic-recorder/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 1: Build .NET Libraries
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Restore .NET dependencies
        run: dotnet restore
      
      - name: Build HttpRecorder library
        run: dotnet build HttpRecorder/HttpRecorder.csproj --configuration ${{ env.CONFIGURATION }} --no-restore
      
      - name: Build HttpRecorder.DevProxy plugin
        run: dotnet build DevProxyExtension/HttpRecorder.DevProxy/HttpRecorder.DevProxy.csproj --configuration ${{ env.CONFIGURATION }} --no-restore
      
      - name: Run .NET tests
        run: dotnet test HttpRecorder.Tests/HttpRecorder.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --framework net9.0 --logger "trx;LogFileName=test-results.trx"
      
      - name: Publish .NET test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: .NET Tests
          path: '**/test-results.trx'
          reporter: dotnet-trx
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2: Create NuGet Package
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Create NuGet package
        run: |
          mkdir -p ./artifacts/nuget
          dotnet pack DevProxyExtension/HttpRecorder.DevProxy/HttpRecorder.DevProxy.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output ./artifacts/nuget \
            /p:Version=${{ steps.get_version.outputs.version }}
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3: Build VS Code Extension with DLLs
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Copy .NET DLLs to extension plugins folder
        run: |
          mkdir -p extensions/traffic-recorder/plugins
          cp DevProxyExtension/HttpRecorder.DevProxy/bin/${{ env.CONFIGURATION }}/net9.0/HttpRecorder.DevProxy.dll extensions/traffic-recorder/plugins/
          cp HttpRecorder/bin/${{ env.CONFIGURATION }}/net9.0/HttpRecorder.dll extensions/traffic-recorder/plugins/
          ls -la extensions/traffic-recorder/plugins/
      
      - name: Install extension dependencies
        working-directory: extensions/traffic-recorder
        run: npm ci
      
      - name: Build extension (includes HAR viewer and MCP server)
        working-directory: extensions/traffic-recorder
        run: npm run build
      
      - name: Run extension tests
        working-directory: extensions/traffic-recorder
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &> /dev/null &
          XVFB_PID=$!
          sleep 2
          npm test
          TEST_EXIT=$?
          kill $XVFB_PID 2>/dev/null || true
          exit $TEST_EXIT
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 4: Package Extension (VSIX)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Package VSIX
        working-directory: extensions/traffic-recorder
        run: |
          mkdir -p ../../artifacts/vsix
          npx @vscode/vsce package --out ../../artifacts/vsix/traffic-cop-${{ steps.get_version.outputs.version }}.vsix
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5: Upload Artifacts
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: artifacts/nuget/*.nupkg
          retention-days: 30
      
      - name: Upload VSIX package
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package
          path: artifacts/vsix/*.vsix
          retention-days: 30
      
      - name: Upload DLLs
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-dlls
          path: |
            DevProxyExtension/HttpRecorder.DevProxy/bin/${{ env.CONFIGURATION }}/net9.0/HttpRecorder.DevProxy.dll
            HttpRecorder/bin/${{ env.CONFIGURATION }}/net9.0/HttpRecorder.dll
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Release Job - Create GitHub Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./release-artifacts
      
      - name: Download VSIX package
        uses: actions/download-artifact@v4
        with:
          name: vsix-package
          path: ./release-artifacts
      
      - name: Update README.md with version
        run: |
          VERSION=${{ needs.build.outputs.version }}
          sed -i "s/traffic-cop-[0-9]\+\.[0-9]\+\.[0-9]\+\.vsix/traffic-cop-$VERSION.vsix/g" README.md
          
          # Show the changes
          git diff README.md
      
      - name: Create/Update Git Tag
        run: |
          VERSION=${{ needs.build.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create or update tag
          git tag -fa "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION" --force
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION=${{ needs.build.outputs.version }}
          cat > release_notes.md << 'EOF'
          ## HttpRecorder Next v$VERSION
          
          ### ðŸ“¦ Installation
          
          **VS Code Extension (Traffic Cop):**
          ```bash
          code --install-extension traffic-cop-$VERSION.vsix
          ```
          
          Or install from [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=MaxGolovanov.traffic-cop)
          
          **Dev Proxy Plugin (NuGet):**
          ```bash
          dotnet add package HttpRecorder.DevProxy --version $VERSION
          ```
          
          Or via NuGet Package Manager:
          ```
          Install-Package HttpRecorder.DevProxy -Version $VERSION
          ```
          
          ### âœ¨ What's Included
          
          - **HttpRecorder.DevProxy.dll** - Dev Proxy plugin for HTTP traffic recording
          - **HttpRecorder.dll** - Core .NET library for HTTP recording
          - **traffic-cop-$VERSION.vsix** - VS Code extension with:
            - HAR file viewer with VS Code theme integration
            - MCP server for AI-powered HAR analysis
            - Auto-detection for 20+ test frameworks
            - Dev Proxy integration
          
          ### ðŸš€ Key Features
          
          - âœ… Full-stack HTTP capture (Browser â†’ Frontend â†’ Backend â†’ APIs)
          - âœ… 20+ test framework support (Playwright, Jest, pytest, JUnit, etc.)
          - âœ… Privacy-first with automatic token anonymization
          - âœ… Standard HAR format compatible with Chrome DevTools
          - âœ… Record & Replay modes for deterministic testing
          - âœ… Beautiful HAR viewer with syntax highlighting
          - âœ… Improved table styling and column widths
          - âœ… Minimal theme for better VS Code integration
          
          ### ðŸ“š Documentation
          
          - [Extension Documentation](https://github.com/maxgolov/HttpRecorderNext/tree/master/extensions/traffic-recorder)
          - [Dev Proxy Plugin Guide](https://github.com/maxgolov/HttpRecorderNext/tree/master/DevProxyExtension)
          - [.NET Library Examples](https://github.com/maxgolov/HttpRecorderNext#net-library-quick-start)
          
          ### ðŸ› Bug Reports & Feature Requests
          
          Please submit issues at: https://github.com/maxgolov/HttpRecorderNext/issues
          EOF
          
          # Replace $VERSION placeholder
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: Release v${{ needs.build.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-artifacts/*.nupkg
            release-artifacts/*.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Optional: Publish to NuGet.org (uncomment when ready)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # - name: Publish to NuGet.org
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   run: |
      #     dotnet nuget push release-artifacts/*.nupkg \
      #       --api-key ${{ secrets.NUGET_API_KEY }} \
      #       --source https://api.nuget.org/v3/index.json \
      #       --skip-duplicate
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Optional: Publish to VS Code Marketplace (uncomment when ready)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # - name: Publish to VS Code Marketplace
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   working-directory: extensions/traffic-recorder
      #   run: |
      #     npx @vscode/vsce publish --packagePath ../../release-artifacts/traffic-cop-${{ needs.build.outputs.version }}.vsix -p ${{ secrets.VSCE_PAT }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Test Installation on Multiple Platforms
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-installation:
    name: Test Installation - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]  # Focus on Ubuntu as requested
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: vsix-package
          path: ./artifacts
      
      - name: Install extension
        shell: bash
        run: |
          vsix=$(find ./artifacts -name "*.vsix" | head -n 1)
          code --install-extension "$vsix" --force || true
          echo "âœ… Extension installation completed"
      
      - name: List installed extensions
        shell: bash
        run: |
          code --list-extensions || true
